# 实施计划

- [x] 1. 升级蒸馏引擎使用 PRD 提示词





  - 将 backend/app.py 中的 DISTILL_SYSTEM_PROMPT 替换为 PRD 定义的完整提示词模板
  - 添加实体类型验证（Concept、Tool、Person、Problem、Solution、Methodology、Metric）
  - 添加关系类型验证（solves、causes、contradicts、consists_of、depends_on、enables、disrupts、powered_by、relates_to）
  - 实现 one-liner 20 字限制的自动截断
  - 添加完整 JSON schema 验证使用 jsonschema 库
  - _需求：1.1、1.2、1.3、1.4、1.5_

- [ ]* 1.1 为蒸馏 schema 验证编写基于属性的测试
  - **属性 2：完整蒸馏 schema 验证**
  - **验证：需求 1.2、1.3、1.5、8.1、8.2、8.3、8.4**

- [ ]* 1.2 为 one-liner 字数约束编写基于属性的测试
  - **属性 3：One-liner 字数约束**
  - **验证：需求 1.4**

- [-] 2. 实现图谱级别管理系统


  - 创建 utils/graphLevelManager.ts 工具类
  - 实现 Level 1 数据转换（想法节点 + 相似度边）
  - 实现 Level 2 数据转换（实体节点 + 关系边）
  - 添加相似度阈值过滤逻辑（默认 0.7）
  - 实现级别转换状态管理
  - _需求：2.1、2.2、2.3、11.2_

- [ ]* 2.1 为相似度阈值过滤编写基于属性的测试
  - **属性 4：Level 1 相似度阈值过滤**
  - **验证：需求 2.2、11.2**

- [ ]* 2.2 为级别转换编写基于属性的测试
  - **属性 5：级别转换保留想法选择**
  - **验证：需求 2.3**

- [ ] 3. 增强 GraphView 组件支持两级视图
  - 修改 components/GraphView.tsx 接受 level 参数
  - 为 Level 1 实现宏观图谱渲染（想法节点）
  - 为 Level 2 实现微观图谱渲染（实体节点）
  - 添加平滑的级别转换动画
  - 在 Level 2 添加返回 Level 1 的按钮
  - 实现基于相似度的边粗细和不透明度
  - 添加悬停时显示相似度分数的工具提示
  - _需求：2.1、2.2、2.3、2.4、11.3、11.4、11.5_

- [ ]* 3.1 为边视觉属性编写基于属性的测试
  - **属性 26：边的视觉属性与相似度相关**
  - **验证：需求 11.3、11.4**

- [ ] 4. 创建进化命令 UI 组件
  - 创建 components/EvolutionCommandUI.tsx
  - 添加"合并想法"按钮（当选择 >= 2 时启用）
  - 添加"拆分想法"按钮（当选择 = 1 时启用）
  - 添加"精炼想法"按钮（在聊天中检测到时显示）
  - 实现确认对话框
  - 添加加载状态和进度指示器
  - _需求：3.2、4.1、5.1_

- [ ]* 4.1 为合并按钮状态编写基于属性的测试
  - **属性 8：多选时启用合并按钮**
  - **验证：需求 4.1**

- [ ] 5. 实现多选想法列表
  - 修改 components/IdeaList.tsx 添加复选框
  - 添加选择状态管理（selectedIds: Set<string>）
  - 实现 onToggleSelection、onSelectAll、onClearSelection
  - 添加"与选中想法聊天"按钮
  - 在列表顶部显示选择计数
  - _需求：9.1、9.2_

- [ ] 6. 实现后端进化处理器
  - 创建 backend/evolution_processor.py
  - 实现 merge_ideas() 函数使用 MERGE_PROMPT
  - 实现 split_idea() 函数使用 SPLIT_PROMPT
  - 实现 refine_idea() 函数使用 REFINE_PROMPT
  - 实现 establish_relationships() 用于管理 linked_idea_ids
  - 添加所有进化操作的错误处理和回滚
  - _需求：3.3、3.4、4.2、4.3、5.2、5.3、5.4、5.5_

- [ ]* 6.1 为精炼内容保留编写基于属性的测试
  - **属性 6：精炼保留原始内容**
  - **验证：需求 3.4**

- [ ]* 6.2 为精炼上下文整合编写基于属性的测试
  - **属性 7：精炼整合两个上下文**
  - **验证：需求 3.3**

- [ ]* 6.3 为合并输出编写基于属性的测试
  - **属性 9：合并输出包含源元素**
  - **验证：需求 4.2**

- [ ]* 6.4 为合并关系编写基于属性的测试
  - **属性 10：合并建立继承关系**
  - **验证：需求 4.3、4.4**

- [ ]* 6.5 为拆分数量编写基于属性的测试
  - **属性 11：拆分产生有效数量的子想法**
  - **验证：需求 5.2**

- [ ]* 6.6 为拆分完整性编写基于属性的测试
  - **属性 12：拆分想法具有完整蒸馏**
  - **验证：需求 5.3**

- [ ]* 6.7 为拆分关系编写基于属性的测试
  - **属性 13：拆分建立父子关系**
  - **验证：需求 5.4、5.5**

- [ ] 7. 添加进化命令 API 端点
  - 在 backend/app.py 添加 /api/merge_ideas 端点
  - 在 backend/app.py 添加 /api/split_idea 端点
  - 在 backend/app.py 添加 /api/refine_idea 端点
  - 实现请求验证和错误处理
  - 添加操作日志记录
  - _需求：3.3、3.4、4.2、4.3、5.2、5.3、5.4、5.5_

- [ ] 8. 连接前端进化命令到后端
  - 在 services/geminiService.ts 添加 mergeIdeas() 函数
  - 在 services/geminiService.ts 添加 splitIdea() 函数
  - 在 services/geminiService.ts 添加 refineIdea() 函数
  - 在 App.tsx 集成进化命令处理
  - 实现 UI 更新和状态刷新
  - 添加成功/错误通知
  - _需求：3.3、3.4、4.2、4.3、5.2、5.3、5.4、5.5_

- [ ] 9. 升级 RAG 引擎使用 PRD 提示词
  - 将 backend/app.py 中的 CHAT_SYSTEM_PROMPT 替换为 PRD 定义的模板
  - 实现上下文构建包含图谱数据和文档片段
  - 添加引用标记 [n] 到响应
  - 实现进化机会检测逻辑
  - 添加建议更新操作的提示
  - _需求：6.1、6.2、6.3、6.4、6.5_

- [ ]* 9.1 为 RAG 上下文完整性编写基于属性的测试
  - **属性 15：RAG 上下文完整性**
  - **验证：需求 6.2**

- [ ]* 9.2 为响应引用格式编写基于属性的测试
  - **属性 16：响应引用格式**
  - **验证：需求 6.3**

- [ ] 10. 实现关键词提取功能
  - 创建 backend/keyword_extractor.py
  - 实现 extract_keywords() 使用 SYSTEM_PROMPT_KEYWORDS
  - 返回 high_level_keywords 和 low_level_keywords
  - 在 RAG 检索中集成关键词提取
  - 在搜索函数中使用两种关键词类型
  - _需求：7.1、7.2、7.3、7.4、7.5_

- [ ]* 10.1 为关键词提取结构编写基于属性的测试
  - **属性 18：关键词提取输出结构**
  - **验证：需求 7.2、7.3、7.4**

- [ ]* 10.2 为关键词使用编写基于属性的测试
  - **属性 19：检索使用两种关键词类型**
  - **验证：需求 7.5**

- [ ] 11. 实现多想法上下文聊天
  - 修改 ChatPanel.tsx 接受多个想法 ID
  - 更新 backend/app.py 的 /api/chat 端点支持多想法上下文
  - 在聊天界面显示上下文中的想法指示器
  - 实现取消选择时的上下文更新
  - 添加用户通知当上下文改变时
  - _需求：9.3、9.4、9.5_

- [ ]* 11.1 为多想法上下文编写基于属性的测试
  - **属性 21：多想法聊天上下文注入**
  - **验证：需求 9.3**

- [ ]* 11.2 为上下文更新编写基于属性的测试
  - **属性 22：取消选择时更新上下文**
  - **验证：需求 9.5**

- [ ] 12. 添加图像上传和 OCR 支持
  - 在捕获界面添加图像上传按钮
  - 实现文件类型验证（jpg、jpeg、png、gif、bmp、webp）
  - 创建 backend/ocr_processor.py
  - 集成 OpenAI Vision API 或 Tesseract OCR
  - 用提取的文本填充文本输入字段
  - 添加 OCR 加载状态和错误处理
  - _需求：10.1、10.2、10.3、10.4、10.5_

- [ ]* 12.1 为图像文件验证编写基于属性的测试
  - **属性 23：图像文件类型验证**
  - **验证：需求 10.2**

- [ ]* 12.2 为 OCR 文本填充编写基于属性的测试
  - **属性 24：OCR 文本填充输入字段**
  - **验证：需求 10.4**

- [ ] 13. 增强余弦相似度计算
  - 验证 backend/app.py 中的 cosine_similarity() 实现
  - 添加输入验证（非零向量）
  - 添加边缘情况处理（零向量、NaN）
  - 优化大规模相似度计算的性能
  - _需求：11.1_

- [ ]* 13.1 为余弦相似度编写基于属性的测试
  - **属性 25：余弦相似度计算**
  - **验证：需求 11.1**

- [ ] 14. 完善聊天历史持久化
  - 验证 chat_history 在消息发送/接收时追加
  - 实现想法切换时自动保存
  - 实现想法加载时聊天历史加载
  - 添加清除聊天历史功能
  - 确保时间戳和角色信息保留
  - _需求：12.1、12.2、12.3、12.4、12.5_

- [ ]* 14.1 为聊天消息追加编写基于属性的测试
  - **属性 27：聊天消息追加到历史**
  - **验证：需求 12.1**

- [ ]* 14.2 为聊天历史持久化编写基于属性的测试
  - **属性 28：导航时聊天历史持久化**
  - **验证：需求 12.2**

- [ ]* 14.3 为聊天历史往返编写基于属性的测试
  - **属性 29：聊天历史往返保留**
  - **验证：需求 12.3、12.4**

- [ ]* 14.4 为聊天历史删除编写基于属性的测试
  - **属性 30：聊天历史选择性删除**
  - **验证：需求 12.5**

- [ ] 15. 添加数据完整性验证
  - 实现 linked_idea_ids 引用完整性检查
  - 在加载时验证所有关系 ID 存在
  - 添加自动清理断开的关系
  - 实现缺失嵌入向量的重新生成
  - 添加数据库损坏检测和修复
  - _需求：8.5_

- [ ]* 15.1 为引用完整性编写基于属性的测试
  - **属性 20：���接想法引用完整性**
  - **验证：需求 8.5**

- [ ] 16. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 17. 添加性能优化
  - 实现图谱布局缓存
  - 添加相似度计算的防抖
  - 为 LLM 调用实现请求队列
  - 添加蒸馏结果缓存
  - 优化大型图谱（100+ 节点）的渲染
  - _性能需求_

- [ ] 18. 改进错误处理和用户反馈
  - 为所有 LLM 调用添加指数退避重试
  - 实现用户友好的错误消息
  - 添加操作进度指示器
  - 实现操作超时处理
  - 添加成功/错误通知 toast
  - _错误处理需求_

- [ ] 19. 更新类型定义
  - 在 types.ts 添加 EntityType 和 RelationType 枚举
  - 添加 EvolutionCommand 类型
  - 添加 RAGContext、KeywordSet、Response 接口
  - 添加 Level1GraphData 和 Level2GraphData 接口
  - 更新 Idea 接口包含新字段（parent_idea_id、child_idea_ids、merged_from_ids）
  - _数据模型需求_

- [ ] 20. 添加中文翻译
  - 在 i18n/translations.ts 添加所有新 UI 文本的翻译
  - 添加进化命令标签
  - 添加错误消息
  - 添加确认对话框文本
  - 添加工具提示和帮助文本
  - _国际化需求_

- [ ] 21. 更新文档
  - 更新 README.md 包含新功能
  - 添加进化命令使用指南
  - 添加图谱级别导航说明
  - 更新 API 配置文档
  - 添加故障排除部分
  - _文档需求_

- [ ] 22. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
