# 两级视图切换逻辑优化 ✅

## 🎯 优化目标

改进宏观视图与微观视图的切换逻辑，使其更加符合用户预期。

## 📋 新的切换逻辑

### 之前的问题
- ❌ 应用启动时自动选中第一个想法并显示 Level 2
- ❌ 无法直接看到 Level 1 宏观视图
- ❌ 切换逻辑不够直观

### 现在的行为 ✅

#### 1. 应用启动
```
启动应用
  ↓
加载所有想法
  ↓
默认显示 Level 1（宏观视图）
  ↓
显示所有想法节点和相似度边
```

#### 2. 进入微观视图（两种方式）

**方式 A：在知识库列表中选择想法**
```
点击知识库中的某个想法
  ↓
自动切换到该想法的 Level 2（微观视图）
  ↓
显示该想法的详细实体关系图
  ↓
右侧显示相关想法和聊天面板
```

**方式 B：在宏观视图中点击节点**
```
在 Level 1 中点击某个想法节点
  ↓
自动切换到该想法的 Level 2（微观视图）
  ↓
同时在知识库列表中高亮该想法
  ↓
显示详细视图和聊天面板
```

#### 3. 返回宏观视图（两种方式）

**方式 A：点击返回按钮**
```
在 Level 2 中点击"← 返回概览"按钮
  ↓
返回 Level 1（宏观视图）
  ↓
清除选中状态
  ↓
显示所有想法的宏观图谱
```

**方式 B：使用键盘快捷键**
```
在 Level 2 中按 ESC 键
  ↓
立即返回 Level 1（宏观视图）
  ↓
清除选中状态
```

## 🎨 UI 布局变化

### Level 1（宏观视图）
```
┌─────────────────────────────────────────────┐
│ 侧边栏 │         图谱视图（全屏）            │
│        │                                     │
│ 想法   │    🌐 宏观视图 (5 想法)            │
│ 列表   │                                     │
│        │         ●─────────●                 │
│        │         │         │                 │
│        │         │    ●────┼────●            │
│        │         │    │    │    │            │
│        │         ●────┼────●    │            │
│        │              │         │            │
│        │              ●─────────●            │
│        │                                     │
│        │              [相似度阈值: 0.70]     │
│        │              ━━━━━━━━━━━━━━━━━━━━  │
└─────────────────────────────────────────────┘
```

### Level 2（微观视图）
```
┌─────────────────────────────────────────────┐
│ 侧边栏 │  图谱视图  │  相关想法 + 聊天      │
│        │            │                       │
│ 想法   │ 🔬 微观视图│  相关想法列表         │
│ 列表   │            │  ─────────────────   │
│ (高亮) │ [Concept]  │  聊天工作台           │
│        │     │      │                       │
│        │ powered_by │  💬 与 AI 对话        │
│        │     │      │                       │
│        │  [Tool]    │  [输入框]             │
│        │            │                       │
│        │ [摘要信息] │                       │
└─────────────────────────────────────────────┘
```

## 🔧 技术实现

### 状态管理变化

```typescript
// 之前：默认选中第一个想法
const [selectedIdeaId, setSelectedIdeaId] = useState<string | null>(
  MOCK_IDEAS[0].idea_id
);

// 现在：默认为 null，显示 Level 1
const [selectedIdeaId, setSelectedIdeaId] = useState<string | null>(null);
```

### 自动切换逻辑

```typescript
// 当选中想法时，自动切换到 Level 2
useEffect(() => {
  if (selectedIdeaId && ideas.length > 0) {
    try {
      graphLevelManager.transitionToLevel2(selectedIdeaId);
      updateGraphData();
    } catch (error) {
      console.error('Failed to transition to Level 2:', error);
    }
  }
}, [selectedIdeaId]);
```

### 返回 Level 1 逻辑

```typescript
const handleBackToLevel1 = () => {
  graphLevelManager.transitionToLevel1();
  // 清除选择，回到宏观视图
  setSelectedIdeaId(null);
  updateGraphData();
};
```

### 条件渲染

```typescript
// Level 1：全屏图谱
<div className={`flex-1 relative bg-slate-950 ${
  graphData?.level === 2 
    ? 'h-1/2 lg:h-full lg:w-2/3 border-b lg:border-b-0 lg:border-r border-slate-800' 
    : 'h-full w-full'
}`}>

// Level 2：图谱 + 聊天面板
{selectedIdea && graphData?.level === 2 && (
  <div className="h-1/2 lg:h-full lg:w-1/3 bg-slate-900 flex flex-col">
    {/* 相关想法 + 聊天 */}
  </div>
)}
```

## 📊 用户流程对比

### 之前的流程
```
1. 打开应用
2. 看到第一个想法的 Level 2 视图
3. 想看宏观视图？需要手动返回
4. 不直观 ❌
```

### 现在的流程
```
1. 打开应用
2. 看到所有想法的 Level 1 宏观视图 ✅
3. 点击任意节点或列表项
4. 进入该想法的 Level 2 微观视图 ✅
5. 点击返回或按 ESC
6. 回到 Level 1 宏观视图 ✅
7. 直观且符合预期 ✅
```

## ✅ 优化清单

- [x] 应用启动时默认显示 Level 1
- [x] 选择想法时自动切换到 Level 2
- [x] Level 1 点击节点切换到 Level 2
- [x] 返回按钮清除选择并回到 Level 1
- [x] ESC 键快捷键清除选择并回到 Level 1
- [x] Level 1 时全屏显示图谱
- [x] Level 2 时显示图谱+聊天面板
- [x] 头部信息只在 Level 2 时显示
- [x] 相似度控制器只在 Level 1 时显示
- [x] 摘要信息只在 Level 2 时显示

## 🎯 使用场景

### 场景 1：浏览所有想法
```
用户想要：查看所有想法的关系
操作：打开应用
结果：✅ 直接看到 Level 1 宏观视图
```

### 场景 2：深入探索某个想法
```
用户想要：了解某个想法的详细结构
操作：在列表中点击想法 或 在图谱中点击节点
结果：✅ 自动切换到 Level 2 微观视图
```

### 场景 3：与想法对话
```
用户想要：与 AI 讨论某个想法
操作：选择想法进入 Level 2
结果：✅ 右侧显示聊天面板，可以立即开始对话
```

### 场景 4：返回全局视角
```
用户想要：回到宏观视图查看整体
操作：点击返回按钮 或 按 ESC 键
结果：✅ 返回 Level 1，清除选择
```

## 🚀 测试步骤

### 1. 测试默认显示
1. 刷新页面
2. **期望**：看到 Level 1 宏观视图，显示所有想法节点
3. **验证**：右上角显示"🌐 宏观视图"

### 2. 测试列表选择
1. 在左侧知识库列表中点击任意想法
2. **期望**：自动切换到该想法的 Level 2 视图
3. **验证**：
   - 右上角显示"🔬 微观视图"
   - 显示该想法的实体关系图
   - 右侧显示聊天面板

### 3. 测试节点点击
1. 返回 Level 1（按 ESC）
2. 在图谱中点击任意节点
3. **期望**：切换到该节点对应想法的 Level 2
4. **验证**：
   - 左侧列表中该想法被高亮
   - 显示详细视图

### 4. 测试返回功能
1. 在 Level 2 中点击"← 返回概览"按钮
2. **期望**：返回 Level 1 宏观视图
3. **验证**：
   - 左侧列表中没有选中项
   - 图谱全屏显示
   - 显示所有想法节点

### 5. 测试键盘快捷键
1. 选择任意想法进入 Level 2
2. 按 ESC 键
3. **期望**：立即返回 Level 1
4. **验证**：与点击返回按钮效果相同

## 💡 用户体验改进

### 改进点 1：更直观的初始状态
- **之前**：打开就看到某个想法的详情，不知道还有其他想法
- **现在**：打开就看到所有想法的全局视图，一目了然 ✅

### 改进点 2：自然的导航流程
- **之前**：需要手动切换级别
- **现在**：选择即切换，返回即清除，符合直觉 ✅

### 改进点 3：合理的空间利用
- **之前**：Level 1 时右侧聊天面板空着
- **现在**：Level 1 全屏显示图谱，Level 2 才显示聊天 ✅

### 改进点 4：清晰的状态指示
- **之前**：不清楚当前在哪个级别
- **现在**：级别指示器、布局变化、UI 元素都清晰指示当前状态 ✅

## 📝 总结

**优化后的两级视图切换逻辑更加完善和直观：**

1. ✅ **默认宏观视图**：应用启动时显示 Level 1
2. ✅ **自动切换**：选择想法时自动进入 Level 2
3. ✅ **双向导航**：可以从列表或图谱进入详情
4. ✅ **清晰返回**：返回按钮和 ESC 键都能回到宏观视图
5. ✅ **智能布局**：根据级别自动调整 UI 布局
6. ✅ **状态同步**：列表选择和图谱视图保持同步

现在的切换逻辑完全符合用户的预期行为！🎉
