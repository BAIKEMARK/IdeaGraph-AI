# 蒸馏引擎修复说明

## 问题诊断

### 错误信息
```
"Failed to parse LLM response: Expecting value: line 1 column 1 (char 0)"
```

### 根本原因
1. **DeepSeek 模型不支持 `response_format` 参数**
   - OpenAI 的 `response_format={"type": "json_object"}` 参数不是所有模型都支持
   - DeepSeek 等模型可能会忽略这个参数或返回空响应

2. **LLM 可能返回 Markdown 格式的 JSON**
   - 有些模型会在 JSON 外面包裹 markdown 代码块（```json ... ```）
   - 直接解析会失败

## 修复方案

### 1. 增强的 JSON 解析
```python
# 尝试直接解析
try:
    distilled = json.loads(result_text)
except json.JSONDecodeError:
    # 尝试从 markdown 代码块中提取 JSON
    if "```json" in result_text:
        # 提取 ```json ... ``` 之间的内容
    elif "```" in result_text:
        # 提取 ``` ... ``` 之间的内容
```

### 2. 兼容性处理 response_format
```python
try:
    # 尝试使用 response_format
    request_params["response_format"] = {"type": "json_object"}
    response = llm_client.chat.completions.create(**request_params)
except Exception:
    # 如果不支持，使用普通模式
    del request_params["response_format"]
    response = llm_client.chat.completions.create(**request_params)
```

### 3. 更明确的提示词
在提示词末尾添加：
```
IMPORTANT: Your response must be ONLY the JSON object, nothing else. 
No explanations, no markdown, just pure JSON.
```

### 4. 调试信息
添加了详细的日志输出：
- 打印 LLM 返回的原始内容前 200 字符
- 显示 JSON 解析过程
- 显示提取的 JSON 内容

## 测试方法

### 1. 运行调试测试
```bash
# 终端 1：启动后端
cd backend
python app.py

# 终端 2：运行调试测试
python backend/tests/test_distill_debug.py
```

这个测试会显示详细的调试信息，帮助诊断问题。

### 2. 运行完整集成测试
```bash
python backend/tests/test_distill_integration.py
```

### 3. 查看后端日志
后端现在会打印：
- LLM 返回的原始内容
- JSON 解析过程
- 验证结果

## 预期结果

修复后，你应该看到：
```
⏱️  Distilling text: ...
   LLM call: XX.XXs
   LLM raw response: {"one_liner": ...
✅ Schema validation passed: X.XXXs
   Embedding call: X.XXs
✅ Total distill time: XX.XXs
```

## 如果仍然失败

### 检查清单
1. ✅ 后端是否正在运行？
2. ✅ `.env` 文件中的 API 密钥是否正确？
3. ✅ LLM 模型是否支持 JSON 输出？
4. ✅ 网络连接是否正常？

### 手动测试 API
```bash
curl -X POST http://localhost:5000/api/distill \
  -H "Content-Type: application/json" \
  -d '{"text": "测试想法"}'
```

### 查看完整错误
运行调试测试脚本会显示完整的错误堆栈和 LLM 原始响应。

## 下一步

如果修复成功，可以继续执行：
- Task 1.1*: 编写基于属性的测试（可选）
- Task 1.2*: 编写 one-liner 约束的属性测试（可选）
- Task 2: 实现图谱级别管理系统
